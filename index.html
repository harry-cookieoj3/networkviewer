<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Viewer Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: monospace; }
        #log-panel {
            position: absolute; top: 0; left: 0; width: 100%; height: 30%;
            background: rgba(0, 0, 0, 0.85); color: #00ff00;
            overflow-y: auto; z-index: 1000; font-size: 12px; padding: 10px;
            border-bottom: 2px solid #555; pointer-events: auto;
        }
        #cy { position: absolute; top: 30%; left: 0; width: 100%; height: 70%; background-color: #fff; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #333; }
        .log-info { color: #00ffff; font-weight: bold; }
    </style>
</head>
<body>
    <div id="log-panel"><div class="log-entry">--- DEBUG & INFO LOG ---</div></div>
    <div id="cy"></div>

    <script>
        const FILE_ID = '1Be7JMrTnqoarJ9R1Bdv3cZttJ0WPa73cisuYTERuYNY';
        const SCALE = 1000; // ここを書き換えるだけで倍率を調整できます

        function log(msg, type = '') {
            const panel = document.getElementById('log-panel');
            const div = document.createElement('div');
            div.className = 'log-entry ' + type;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            panel.appendChild(div);
            panel.scrollTop = panel.scrollHeight;
        }

        async function fetchData(url, name) {
            const response = await fetch(url);
            const text = await response.text();
            return Papa.parse(text, { header: true, skipEmptyLines: true, transformHeader: h => h.trim().toLowerCase() }).data;
        }

        async function init() {
            const nodeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=0`;
            const edgeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=1184231939`;

            try {
                const [nodesData, edgesData] = await Promise.all([
                    fetchData(nodeUrl, "ノード"),
                    fetchData(edgeUrl, "エッジ")
                ]);

                const elements = [];
                const nodeIdSet = new Set();

                nodesData.forEach(row => {
                    const id = String(row.id || row.Id || "").trim();
                    if (id) {
                        elements.push({
                            group: 'nodes',
                            data: { 
                                id: id, 
                                label: row.label || id,
                                nodeColor: row.color || row.Color || '#1a73e8',
                                rawData: row // 全データを保持させておく
                            },
                            // 座標をSCALE倍して配置
                            position: { 
                                x: parseFloat(row.x || 0) * SCALE, 
                                y: parseFloat(row.y || 0) * SCALE 
                            }
                        });
                        nodeIdSet.add(id);
                    }
                });

                edgesData.forEach(row => {
                    const s = String(row.source || "").trim();
                    const t = String(row.target || "").trim();
                    if (nodeIdSet.has(s) && nodeIdSet.has(t)) {
                        elements.push({
                            group: 'edges',
                            data: { source: s, target: t }
                        });
                    }
                });

                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: { 'label': 'data(label)', 'background-color': 'data(nodeColor)', 'width': 10, 'height': 10, 'font-size': '8px' } },
                        { selector: 'edge', style: { 'width': 1, 'line-color': '#ccc', 'opacity': 0.3, 'curve-style': 'haystack' } }
                    ],
                    layout: { name: 'preset' }, // 固定配置モード
                    autoungrabify: true // ノードのドラッグを禁止
                });

                // ポイント（ホバー）した時のイベント
                cy.on('mouseover tap', 'node', function(evt){
                    const data = evt.target.data('rawData');
                    let info = "【ノード詳細】";
                    for(let key in data) {
                        info += ` ${key}: ${data[key]} |`;
                    }
                    log(info, 'log-info');
                });

                log(`表示完了: ${elements.length}件。ノードを触ると詳細が表示されます。倍率: ${SCALE}倍`);

            } catch (e) {
                log("エラー: " + e.message, 'log-error');
            }
        }
        init();
    </script>
</body>
</html>
