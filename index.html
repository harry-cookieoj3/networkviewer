<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Live Idol Network Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: monospace; background: #fff; } 
        #log-panel { 
            position: absolute; top: 0; left: 0; width: 100%; height: 18%; 
            background: rgba(0,0,0,0.85); color: #0f0; overflow-y: auto; z-index: 9999; 
            padding: 10px; font-size: 11px; border-bottom: 2px solid #555;
        }
        #cy { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    </style>
</head>
<body>
    <div id="log-panel"></div>
    <div id="cy"></div>

    <script>
        const logPanel = document.getElementById('log-panel');
        function addLog(msg, color='') {
            const div = document.createElement('div');
            div.style.color = color;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logPanel.appendChild(div);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // --- 設定エリア (ここを書き換えてください) ---
        const CONFIG = {
            gasUrl: "https://script.google.com/macros/s/AKfycbxLSa95r08HRbuQhEWUgVSUSeSaUmJxpA8fRZ4NVAbiGLhVA3kFkEdbEVIvlr2HWcAn/exec", 
            token: "my-secret-token-2026", // GASで設定したトークン
            baseNodeSize: 225, 
            baseFontSize: 1500,
            edgeWidth: 25,
            centerX: 9370,   
            centerY: 9140,   
            initialZoom: 0.005
        };

        async function start() {
            try {
                addLog("GASからデータを取得中...");
                
                // GASからデータを取得
                const response = await fetch(`${CONFIG.gasUrl}?token=${CONFIG.token}`);
                if (!response.ok) throw new Error("通信エラーが発生しました");
                const fullData = await response.json();

                addLog(`データ受信完了 (Nodes: ${fullData.nodes.length}件)`);

                // Cytoscape用のデータ形式に変換
                const elements = [];
                
                fullData.nodes.forEach(n => {
                    const id = String(n.id);
                    const nSize = parseFloat(n.size || 10) * CONFIG.baseNodeSize;
                    elements.push({
                        group: 'nodes',
                        data: { id, label: n.label || id, color: n.color || '#1a73e8', size: nSize },
                        position: { x: parseFloat(n.x || 0), y: -parseFloat(n.y || 0) }
                    });
                });

                fullData.edges.forEach(e => {
                    const s = String(e.source);
                    const t = String(e.target);
                    elements.push({ group: 'edges', data: { source: s, target: t } });
                });

                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: {
                            'width': 'data(size)', 'height': 'data(size)',
                            'label': 'data(label)', 'font-size': CONFIG.baseFontSize,
                            'background-color': 'data(color)',
                            'text-outline-width': 20, 'text-outline-color': '#fff',
                            'color': '#000', 'font-weight': 'bold'
                        }},
                        { selector: 'edge', style: { 
                            'width': CONFIG.edgeWidth, 'line-color': '#999', 'opacity': 0.3, 'curve-style': 'haystack'
                        }},
                        { selector: '.faded', style: { 'opacity': 0.03, 'text-opacity': 0 }},
                        { selector: '.highlight', style: {
                            'opacity': 1, 'font-size': CONFIG.baseFontSize * 1.8, 'text-outline-width': 40, 'z-index': 999
                        }},
                        { selector: '.edge-highlight', style: {
                            'opacity': 1, 'width': CONFIG.edgeWidth * 2.5, 'line-color': '#222', 'z-index': 998
                        }}
                    ],
                    layout: { name: 'preset' },
                    autoungrabify: true
                });

                cy.viewport({
                    zoom: CONFIG.initialZoom,
                    pan: { 
                        x: cy.width() / 2 - CONFIG.centerX * CONFIG.initialZoom, 
                        y: cy.height() / 2 - (-CONFIG.centerY) * CONFIG.initialZoom 
                    }
                });

                cy.on('tap', 'node', function(e){
                    const node = e.target;
                    const neighborhood = node.neighborhood().add(node);
                    cy.elements().addClass('faded').removeClass('highlight edge-highlight');
                    neighborhood.removeClass('faded').addClass('highlight');
                    node.connectedEdges().removeClass('faded').addClass('edge-highlight');
                    addLog(`選択: ${node.data('label')}`);
                });

                cy.on('tap', function(e){
                    if( e.target === cy ){
                        cy.elements().removeClass('faded highlight edge-highlight');
                    }
                });

                addLog("システム正常稼働中");

            } catch (err) {
                addLog("エラー: " + err.message, "#f00");
                console.error(err);
            }
        }
        start();
    </script>
</body>
</html>
