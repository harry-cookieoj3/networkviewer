<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Viewer - Final Debug</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #fff; font-family: monospace; }
        /* ログパネル */
        #log-panel { 
            position: absolute; top: 0; left: 0; width: 100%; height: 25%; 
            background: rgba(0, 0, 0, 0.9); color: #00ff00; 
            overflow-y: auto; z-index: 1000; font-size: 11px; padding: 10px; 
            border-bottom: 2px solid #555; pointer-events: auto;
        }
        /* グラフエリア */
        #cy { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #333; }
        .log-info { color: #00ffff; }
        .log-error { color: #ff4444; font-weight: bold; }
    </style>
</head>
<body>

    <div id="log-panel"><div class="log-entry">--- SYSTEM READY ---</div></div>
    <div id="cy"></div>

    <script>
        const FILE_ID = '1Be7JMrTnqoarJ9R1Bdv3cZttJ0WPa73cisuYTERuYNY';
        
        // --- 調整用パラメータ ---
        const COORD_SCALE = 0.1;   // 座標をどれくらい縮めるか（0.1 = 10分の1に凝縮）
        const NODE_SIZE = 300;     // ノードの大きさ
        const FONT_SIZE = 200;     // 文字の大きさ
        const EDGE_WIDTH = 30;     // 線の太さ
        // -----------------------

        function log(msg, type = '') {
            const panel = document.getElementById('log-panel');
            const div = document.createElement('div');
            div.className = 'log-entry ' + type;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            panel.appendChild(div);
            panel.scrollTop = panel.scrollHeight;
        }

        async function fetchData(url, name) {
            log(`${name}データ取得中...`);
            const response = await fetch(url);
            if (!response.ok) throw new Error(`${name}の取得に失敗しました`);
            const text = await response.text();
            return Papa.parse(text, { 
                header: true, 
                skipEmptyLines: true, 
                transformHeader: h => h.trim().toLowerCase() 
            }).data;
        }

        async function init() {
            const nodeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=0`;
            const edgeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=1184231939`;

            try {
                const [nodesData, edgesData] = await Promise.all([
                    fetchData(nodeUrl, "ノード"),
                    fetchData(edgeUrl, "エッジ")
                ]);

                log(`データ解析完了: ノード ${nodesData.length}件 / エッジ ${edgesData.length}件`);

                const elements = [];
                const nodeIdSet = new Set();

                // 1. ノードの構築
                nodesData.forEach((row, i) => {
                    const id = String(row.id || row.Id || "").trim();
                    if (!id) return;

                    const rawX = parseFloat(row.x || 0);
                    const rawY = parseFloat(row.y || 0);

                    elements.push({
                        group: 'nodes',
                        data: { 
                            id: id, 
                            label: row.label || id,
                            nodeColor: row.color || row.Color || '#1a73e8',
                            rawData: row 
                        },
                        // 巨大な座標をスケールダウンして配置
                        position: { x: rawX * COORD_SCALE, y: rawY * COORD_SCALE }
                    });
                    nodeIdSet.add(id);
                });

                // 2. エッジの構築
                edgesData.forEach(row => {
                    const s = String(row.source || "").trim();
                    const t = String(row.target || "").trim();
                    if (nodeIdSet.has(s) && nodeIdSet.has(t)) {
                        elements.push({
                            group: 'edges',
                            data: { source: s, target: t }
                        });
                    }
                });

                log("描画エンジン起動...");
                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: {
                            'width': NODE_SIZE,
                            'height': NODE_SIZE,
                            'label': 'data(label)',
                            'background-color': 'data(nodeColor)',
                            'font-size': FONT_SIZE,
                            'text-valign': 'bottom',
                            'text-margin-y': 40,
                            'text-outline-width': 10,
                            'text-outline-color': '#fff',
                            'color': '#000',
                            'font-weight': 'bold'
                        }},
                        { selector: 'edge', style: {
                            'width': EDGE_WIDTH,
                            'line-color': '#ccc',
                            'opacity': 0.4,
                            'curve-style': 'haystack'
                        }}
                    ],
                    layout: { name: 'preset' },
                    autoungrabify: true,
                    wheelSensitivity: 0.1
                });

                // 画面内に全要素を収める
                cy.fit(null, 500);
                log(`描画完了！現在のズーム: ${cy.zoom().toFixed(5)}`);

                // インタラクション設定
                cy.on('mouseover tap', 'node', function(evt){
                    const d = evt.target.data('rawData');
                    log(`【選択中】ID:${d.id || d.Id} | Label:${d.label} | 原点座標(${d.x}, ${d.y})`, 'log-info');
                });

            } catch (e) {
                log("致命的なエラー: " + e.message, 'log-error');
                console.error(e);
            }
        }

        init();
    </script>
</body>
</html>
