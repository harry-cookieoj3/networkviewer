<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Viewer Debug</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: monospace; }
        #log-panel { position: absolute; top: 0; left: 0; width: 100%; height: 30%; background: rgba(0, 0, 0, 0.85); color: #00ff00; overflow-y: auto; z-index: 1000; font-size: 12px; padding: 10px; border-bottom: 2px solid #555; }
        #cy { position: absolute; top: 30%; left: 0; width: 100%; height: 70%; background-color: #fff; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #333; }
        .log-info { color: #00ffff; }
        .log-error { color: #ff4444; font-weight: bold; }
    </style>
</head>
<body>
    <div id="log-panel"><div class="log-entry">--- DEBUG START ---</div></div>
    <div id="cy"></div>

    <script>
        const FILE_ID = '1Be7JMrTnqoarJ9R1Bdv3cZttJ0WPa73cisuYTERuYNY';
        
        // 調整用パラメータ
        const SCALE = 200;       
        const NODE_SIZE = 100;    
        const FONT_SIZE = 80;     
        const EDGE_WIDTH = 5;     

        function log(msg, type = '') {
            const panel = document.getElementById('log-panel');
            const div = document.createElement('div');
            div.className = 'log-entry ' + type;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            panel.appendChild(div);
            panel.scrollTop = panel.scrollHeight;
        }

        async function fetchData(url, name) {
            log(`${name}読み込み中...`);
            const response = await fetch(url);
            if (!response.ok) throw new Error(`${name}の通信エラー`);
            const text = await response.text();
            return Papa.parse(text, { header: true, skipEmptyLines: true, transformHeader: h => h.trim().toLowerCase() }).data;
        }

        async function init() {
            const nodeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=0`;
            const edgeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=1184231939`;

            try {
                const [nodesData, edgesData] = await Promise.all([
                    fetchData(nodeUrl, "ノード"),
                    fetchData(edgeUrl, "エッジ")
                ]);

                log(`ノード取得数: ${nodesData.length}`);
                const elements = [];
                const nodeIdSet = new Set();

                nodesData.forEach((row, index) => {
                    const id = String(row.id || row.Id || "").trim();
                    if (!id) return;

                    // 数値チェック：x, y が不正なら 0 にする
                    const rawX = parseFloat(row.x);
                    const rawY = parseFloat(row.y);
                    const posX = isNaN(rawX) ? 0 : rawX * SCALE;
                    const posY = isNaN(rawY) ? 0 : rawY * SCALE;

                    elements.push({
                        group: 'nodes',
                        data: { 
                            id: id, 
                            label: row.label || id,
                            nodeColor: row.color || row.Color || '#1a73e8',
                            rawData: row 
                        },
                        position: { x: posX, y: posY }
                    });
                    nodeIdSet.add(id);
                });

                edgesData.forEach(row => {
                    const s = String(row.source || "").trim();
                    const t = String(row.target || "").trim();
                    if (nodeIdSet.has(s) && nodeIdSet.has(t)) {
                        elements.push({
                            group: 'edges',
                            data: { source: s, target: t }
                        });
                    }
                });

                log("Cytoscape描画開始...");
                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: {
                            'label': 'data(label)',
                            'background-color': 'data(nodeColor)',
                            'width': NODE_SIZE,
                            'height': NODE_SIZE,
                            'font-size': FONT_SIZE,
                            'text-valign': 'bottom',
                            'text-margin-y': 10,
                            'text-outline-width': 3,
                            'text-outline-color': '#fff'
                        }},
                        { selector: 'edge', style: {
                            'width': EDGE_WIDTH,
                            'line-color': '#ccc',
                            'opacity': 0.5,
                            'curve-style': 'haystack'
                        }}
                    ],
                    layout: { name: 'preset' },
                    autoungrabify: true,
                    wheelSensitivity: 0.2 // スクロール拡大の感度
                });

                // 描画後、全要素が見えるように自動ズーム
                cy.fit(null, 100); 

                cy.on('mouseover tap', 'node', function(evt){
                    const data = evt.target.data('rawData');
                    log(`【詳細】ID:${data.id || data.Id} | Label:${data.label} | x:${data.x} | y:${data.y}`, 'log-info');
                });

                log("描画完了。真っ白な場合は画面をピンチアウト（縮小）してみてください。");

            } catch (e) {
                log("エラー発生: " + e.message, 'log-error');
                console.error(e);
            }
        }
        init();
    </script>
</body>
</html>
