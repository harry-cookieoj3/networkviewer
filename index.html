<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #cy { width: 100vw; height: 100vh; background-color: #ffffff; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; font-family: sans-serif; text-align: center; }
    </style>
</head>
<body>
    <div id="loading">データを取得中...<br><span id="status"></span></div>
    <div id="cy"></div>

    <script>
        const FILE_ID = '1Be7JMrTnqoarJ9R1Bdv3cZttJ0WPa73cisuYTERuYNY';
        // 直接エクスポート用URLを作成
        const NODE_URL = `https://docs.google.com/spreadsheets/d/${FILE_ID}/export?format=csv&gid=0`;
        const EDGE_URL = `https://docs.google.com/spreadsheets/d/${FILE_ID}/export?format=csv&gid=1184231939`;

        async function fetchData(url, name) {
            document.getElementById('status').innerText = name + "...";
            const response = await fetch(url);
            if (!response.ok) throw new Error(name + "の取得に失敗。スプレッドシートの共有が「全員」になっているか確認してください。");
            const text = await response.text();
            return Papa.parse(text, { header: true, skipEmptyLines: true, transformHeader: h => h.trim().toLowerCase() }).data;
        }

        async function init() {
            try {
                const [nodesData, edgesData] = await Promise.all([
                    fetchData(NODE_URL, "ノード"),
                    fetchData(EDGE_URL, "エッジ")
                ]);

                const elements = [];
                nodesData.forEach(row => {
                    const id = row.id || row.Id;
                    if (id) {
                        elements.push({
                            group: 'nodes',
                            data: { id: String(id), label: row.label || id, color: row.color || '#1a73e8' },
                            position: { x: row.x ? parseFloat(row.x) : undefined, y: row.y ? parseFloat(row.y) : undefined }
                        });
                    }
                });

                edgesData.forEach(row => {
                    if (row.source && row.target) {
                        elements.push({
                            group: 'edges',
                            data: { source: String(row.source), target: String(row.target) }
                        });
                    }
                });

                document.getElementById('loading').style.display = 'none';

                cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: { 'label': 'data(label)', 'background-color': 'data(color)', 'width': 12, 'height': 12, 'font-size': '8px', 'text-valign': 'bottom', 'color': '#333' } },
                        { selector: 'edge', style: { 'width': 0.8, 'line-color': '#ddd', 'curve-style': 'haystack', 'opacity': 0.6 } }
                    ],
                    layout: { name: (nodesData[0] && nodesData[0].x) ? 'preset' : 'cose', fit: true, padding: 30 }
                });
            } catch (e) {
                document.getElementById('loading').innerHTML = `<div style="color:red">エラー: ${e.message}</div>`;
            }
        }
        init();
    </script>
</body>
</html>
