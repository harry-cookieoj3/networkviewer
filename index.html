<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Live Idol Network Viewer - Directional (Stable)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #fff; }
        #cy { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #status-log {
            position: absolute; bottom: 10px; right: 10px; z-index: 100;
            background: rgba(0,0,0,0.7); color: #0f0; padding: 10px;
            font-family: monospace; font-size: 12px; border-radius: 5px;
            max-width: 350px; pointer-events: none;
        }
        #ui-layer {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            display: flex; flex-direction: column; gap: 10px;
        }
        .btn {
            padding: 8px 15px; background: #333; color: #fff; border: none;
            border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        #legend {
            position: absolute; top: 60px; left: 10px; z-index: 100;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px;
            font-size: 12px; border: 1px solid #ccc;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 3px; }
        .color-box { width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <button class="btn" onclick="resetSelection()">選択解除 / 全体表示</button>
    </div>

    <div id="legend">
        <strong>エッジの方向</strong>
        <div class="legend-item"><div class="color-box" style="background: red;"></div> 出る (Source →)</div>
        <div class="legend-item"><div class="color-box" style="background: blue;"></div> 入る (→ Target)</div>
        <div class="legend-item"><div class="color-box" style="background: #ccc;"></div> 通常</div>
    </div>

    <div id="status-log">Initializing...</div>
    <div id="cy"></div>

    <script>
        let cy;
        const logEl = document.getElementById('status-log');
        function addLog(msg) { logEl.innerText = msg; console.log(msg); }

        const CONFIG = {
            gasUrl: "https://script.google.com/macros/s/AKfycbxLSa95r08HRbuQhEWUgVSUSeSaUmJxpA8fRZ4NVAbiGLhVA3kFkEdbEVIvlr2HWcAn/exec", 
            token: "my-secret-token-2026",
            baseNodeSize: 225, 
            baseFontSize: 1500,
            edgeWidth: 35,
            centerX: 9370,   
            centerY: 9140,   
            initialZoom: 0.005
        };

        async function start() {
            addLog("GASからデータ取得中...");
            try {
                const response = await fetch(`${CONFIG.gasUrl}?token=${CONFIG.token}`, { redirect: 'follow' });
                if (!response.ok) throw new Error("通信エラー: " + response.status);
                
                const fullData = await response.json();
                addLog(`データ受信完了 (Nodes: ${fullData.nodes.length})`);

                const elements = [];
                // Nodeの作成
                fullData.nodes.forEach(n => {
                    elements.push({
                        group: 'nodes',
                        data: { 
                            id: String(n.id), 
                            label: n.label, 
                            color: n.color, 
                            size: parseFloat(n.size) * CONFIG.baseNodeSize 
                        },
                        position: { x: parseFloat(n.x), y: parseFloat(n.y) }
                    });
                });

                // Edgeの作成（エラー回避ガード付）
                const nodeIds = new Set(fullData.nodes.map(n => String(n.id)));
                let skipped = 0;
                fullData.edges.forEach(e => {
                    if (nodeIds.has(String(e.source)) && nodeIds.has(String(e.target))) {
                        elements.push({ group: 'edges', data: { source: String(e.source), target: String(e.target) } });
                    } else {
                        skipped++;
                    }
                });

                if (skipped > 0) addLog(`警告: 不整合エッジ ${skipped}件を無視しました`);

                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: {
                            'width': 'data(size)', 'height': 'data(size)',
                            'label': 'data(label)', 'font-size': CONFIG.baseFontSize,
                            'background-color': 'data(color)',
                            'text-outline-width': 20, 'text-outline-color': '#fff',
                            'z-index': 10
                        }},
                        { selector: 'edge', style: { 
                            'width': CONFIG.edgeWidth, 'line-color': '#ccc', 'opacity': 0.3,
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'triangle', 'target-arrow-color': '#ccc',
                            'arrow-scale': 4
                        }},
                        { selector: '.faded', style: { 'opacity': 0.05, 'text-opacity': 0 }},
                        { selector: '.highlight-node', style: { 'z-index': 999, 'border-width': 50, 'border-color': '#000' }},
                        { selector: '.edge-out', style: { 'line-color': 'red', 'target-arrow-color': 'red', 'opacity': 1, 'z-index': 100 }},
                        { selector: '.edge-in', style: { 'line-color': 'blue', 'target-arrow-color': 'blue', 'opacity': 1, 'z-index': 100 }}
                    ],
                    layout: { name: 'preset' },
                    wheelSensitivity: 0.1
                });

                cy.on('tap', 'node', function(e){
                    const selNode = e.target;
                    const id = selNode.id();
                    cy.elements().addClass('faded').removeClass('highlight-node edge-out edge-in');
                    selNode.removeClass('faded').addClass('highlight-node');
                    selNode.connectedEdges().forEach(edge => {
                        edge.removeClass('faded');
                        if (edge.source().id() === id) {
                            edge.addClass('edge-out');
                        } else {
                            edge.addClass('edge-in');
                        }
                    });
                    selNode.neighborhood().nodes().removeClass('faded');
                });

                cy.viewport({
                    zoom: CONFIG.initialZoom,
                    pan: { 
                        x: cy.width() / 2 - CONFIG.centerX * CONFIG.initialZoom, 
                        y: cy.height() / 2 - CONFIG.centerY * CONFIG.initialZoom 
                    }
                });

                addLog("描画完了。不整合チェック済。");

            } catch (err) {
                addLog("エラー発生: " + err.message);
                console.error(err);
            }
        }

        function resetSelection() {
            cy.elements().removeClass('faded highlight-node edge-out edge-in');
            addLog("選択解除しました。");
        }

        start();
    </script>
</body>
</html>
