<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Network Viewer - Spacing Adjusted</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* 背景を薄いグレーにして線を見やすくしました */
        body { margin: 0; overflow: hidden; font-family: monospace; background: #f0f0f0; } 
        #log-panel { 
            position: absolute; top: 0; left: 0; width: 100%; height: 20%; 
            background: rgba(0,0,0,0.85); color: #0f0; overflow-y: auto; z-index: 9999; 
            padding: 10px; font-size: 11px; border-bottom: 2px solid #555;
        }
        #cy { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    </style>
</head>
<body>
    <div id="log-panel"></div>
    <div id="cy"></div>

    <script>
        const logPanel = document.getElementById('log-panel');
        function addLog(msg, color='') {
            const div = document.createElement('div');
            div.style.color = color;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logPanel.appendChild(div);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        const FILE_ID = '1Be7JMrTnqoarJ9R1Bdv3cZttJ0WPa73cisuYTERuYNY';
        
        // --- 調整用パラメータ ---
        const CONFIG = {
            COORD_DIST_SCALE: 1.5, // 距離を1.5倍に広げる (もっと離したい場合はここを2.0などに)
            nodeSize: 2800,        // ノードをさらに強調
            fontSize: 1400,  
            edgeWidth: 25,         // 線を太く
            edgeColor: '#999',     // 線の色を濃く
            defaultColor: '#1a73e8',
            // 初期表示位置 (倍率を掛けて計算)
            centerX: 9370,   
            centerY: 9140,   
            initialZoom: 0.003     // 距離を離した分、さらに引き(0.003)に設定
        };

        async function start() {
            try {
                addLog("間隔を広げ、背景色を調整して表示中...");
                const nodeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=0`;
                const edgeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=1184231939`;

                const [resN, resE] = await Promise.all([fetch(nodeUrl), fetch(edgeUrl)]);
                const [txtN, txtE] = await Promise.all([resN.text(), resE.text()]);
                
                const nodesData = Papa.parse(txtN, {header:true, skipEmptyLines:true}).data;
                const edgesData = Papa.parse(txtE, {header:true, skipEmptyLines:true}).data;

                const elements = [];
                const nodeIds = new Set();

                nodesData.forEach(n => {
                    const id = (n.id || n.Id || "").trim();
                    if(!id) return;
                    const nColor = n.color || n.Color || CONFIG.defaultColor;

                    elements.push({
                        group: 'nodes',
                        data: { id, label: n.label || id, color: nColor, raw: n },
                        // 座標をスケールさせて距離を離す
                        position: { 
                            x: parseFloat(n.x || 0) * CONFIG.COORD_DIST_SCALE, 
                            y: -parseFloat(n.y || 0) * CONFIG.COORD_DIST_SCALE 
                        }
                    });
                    nodeIds.add(id);
                });

                edgesData.forEach(e => {
                    const s = (e.source || "").trim();
                    const t = (e.target || "").trim();
                    if(nodeIds.has(s) && nodeIds.has(t)) {
                        elements.push({ group: 'edges', data: { source: s, target: t } });
                    }
                });

                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: {
                            'width': CONFIG.nodeSize, 'height': CONFIG.nodeSize,
                            'label': 'data(label)', 'font-size': CONFIG.fontSize,
                            'background-color': 'data(color)',
                            'text-outline-width': 30, 'text-outline-color': '#fff',
                            'color': '#333', 'font-weight': 'bold'
                        }},
                        { selector: 'edge', style: { 
                            'width': CONFIG.edgeWidth, 
                            'line-color': CONFIG.edgeColor, 
                            'opacity': 0.5, // 線の透明度を上げて見やすく
                            'curve-style': 'haystack'
                        }}
                    ],
                    layout: { name: 'preset' },
                    autoungrabify: true
                });

                // 初期位置への移動 (距離倍率を考慮)
                const viewX = CONFIG.centerX * CONFIG.COORD_DIST_SCALE;
                const viewY = -CONFIG.centerY * CONFIG.COORD_DIST_SCALE;

                cy.viewport({
                    zoom: CONFIG.initialZoom,
                    pan: { 
                        x: cy.width() / 2 - viewX * CONFIG.initialZoom, 
                        y: cy.height() / 2 - viewY * CONFIG.initialZoom 
                    }
                });

                addLog(`表示完了。距離倍率:${CONFIG.COORD_DIST_SCALE} / ズーム:${CONFIG.initialZoom}`, "#0f0");

                cy.on('tap', 'node', function(evt){
                    const d = evt.target.data('raw');
                    addLog(`【詳細】${d.label || d.id} (x:${d.x}, y:${d.y})`, "#0ff");
                });

            } catch (err) {
                addLog("エラー: " + err.message, "#f00");
            }
        }
        start();
    </script>
</body>
</html>
