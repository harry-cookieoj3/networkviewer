<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Idol Network Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', Arial, sans-serif; background: #fff; color: #333; }
        #cy { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UIÂ±§ */
        #ui-layer {
            position: absolute; top: 15px; left: 15px; z-index: 100;
            display: flex; flex-direction: column; gap: 8px; width: 280px;
        }
        .search-container { position: relative; }
        #node-search {
            width: 100%; padding: 12px; border: 2px solid #333; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none;
        }
        #search-results {
            position: absolute; top: 100%; left: 0; width: 100%; background: #fff; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none; z-index: 101;
        }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .btn { padding: 10px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* „Çµ„Ç§„Éâ„Éë„Éç„É´ */
        #side-panel {
            position: absolute; right: -400px; top: 0; width: 350px; height: 100%;
            background: rgba(255, 255, 255, 0.98); box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 2000; transition: 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; overflow-y: auto;
        }
        #side-panel.open { right: 0; }
        .panel-close { align-self: flex-end; cursor: pointer; font-size: 24px; font-weight: bold; color: #999; }
        
        /* „ÉÑ„Ç¢„Éº„Ç≥„É≥„Éà„É≠„Éº„É´ÔºöÈáç„Å™„ÇäÈ†Ü„ÇíÊúÄÂâçÈù¢„Å´ */
        #tour-control { 
            position: relative; z-index: 3000; 
            padding: 12px; background: #f0f7ff; border-radius: 10px; border: 1px solid #cce3ff; 
        }
        .tour-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .tour-label { font-weight: bold; font-size: 14px; color: #0056b3; pointer-events: none; }
        #tour-switch { width: 24px; height: 24px; cursor: pointer; margin: 0; z-index: 3001; }
        
        #tour-status { font-size: 12px; color: #666; display: none; margin-top: 8px; }
        .jump-btn { background: #0056b3; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }

        .lastfm-btn { display: block; padding: 12px; background: #ba0000; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold; }
        #spotify-area { min-height: 152px; border-radius: 12px; background: #f8f8f8; overflow: hidden; border: none; z-index: 10; }

        @media screen and (max-width: 768px) {
            #side-panel { right: 0; bottom: -100%; top: auto; width: 100%; height: 65%; border-radius: 20px 20px 0 0; }
            #side-panel.open { bottom: 0; }
        }
        #status-log { position: absolute; bottom: 5px; right: 5px; z-index: 100; background: rgba(0,0,0,0.6); color: #0f0; padding: 5px 10px; font-size: 10px; border-radius: 3px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="search-container">
            <input type="text" id="node-search" placeholder="„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÊ§úÁ¥¢..." autocomplete="off">
            <div id="search-results"></div>
        </div>
        <button class="btn" onclick="resetSelection()">ÂÖ®‰Ωì„ÇíË°®Á§∫ / Ëß£Èô§</button>
    </div>

    <div id="side-panel">
        <span class="panel-close" onclick="closePanel()">√ó</span>
        <h2 id="panel-title" style="margin: 0;">Artist Name</h2>
        
        <div id="link-area"></div>

        <div id="tour-control">
            <div class="tour-header" id="tour-label-area">
                <span class="tour-label">üîÑ „ÉÑ„Ç¢„ÉºÂÜçÁîü„É¢„Éº„Éâ</span>
                <input type="checkbox" id="tour-switch">
            </div>
            <div id="tour-status">
                ÁßªÂãï„Åæ„Åß: <span id="timer-count" style="font-weight: bold; color: #333;">60</span>Áßí
                <button class="jump-btn" onclick="jumpNextNode()">„Åô„Åê„Å´Ê¨°„Å∏</button>
            </div>
        </div>

        <div id="spotify-area"></div>
    </div>

    <div id="status-log">Initializing...</div>
    <div id="cy"></div>

    <script>
        let cy;
        let tourInterval = null;
        let timeLeft = 60;
        const DEFAULT_TIME = 60;

        const logEl = document.getElementById('status-log');
        const searchInput = document.getElementById('node-search');
        const searchResults = document.getElementById('search-results');
        const sidePanel = document.getElementById('side-panel');

        const CONFIG = {
            gasUrl: "https://script.google.com/macros/s/AKfycbxLSa95r08HRbuQhEWUgVSUSeSaUmJxpA8fRZ4NVAbiGLhVA3kFkEdbEVIvlr2HWcAn/exec", 
            token: "my-secret-token-2026",
            baseNodeSize: 225, baseFontSize: 1500, edgeWidth: 35
        };

        function addLog(msg) { logEl.innerText = msg; }

        function adjustView(animate = true) {
            if (!cy) return;
            const isMobile = window.innerWidth < 768;
            cy.animate({ fit: { eles: cy.elements(), padding: isMobile ? 30 : 60 } }, { duration: animate ? 600 : 0 });
        }

        async function start() {
            addLog("„Éá„Éº„ÇøÂèñÂæó‰∏≠...");
            try {
                const response = await fetch(`${CONFIG.gasUrl}?token=${CONFIG.token}`, { redirect: 'follow' });
                const fullData = await response.json();

                const elements = [];
                fullData.nodes.forEach(n => {
                    elements.push({
                        group: 'nodes',
                        data: { id: String(n.id), label: n.label, color: n.color, size: parseFloat(n.size) * CONFIG.baseNodeSize, spotify_id: n.spotify_id, url_lastfm: n.url_lastfm },
                        position: { x: parseFloat(n.x), y: -parseFloat(n.y) }
                    });
                });

                const nodeIds = new Set(fullData.nodes.map(n => String(n.id)));
                fullData.edges.forEach(e => {
                    const s = String(e.source); const t = String(e.target);
                    if (s !== t && nodeIds.has(s) && nodeIds.has(t)) {
                        elements.push({ group: 'edges', data: { source: s, target: t } });
                    }
                });

                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    minZoom: 0.001, maxZoom: 0.1,
                    style: [
                        { selector: 'node', style: { 'width': 'data(size)', 'height': 'data(size)', 'label': 'data(label)', 'font-size': CONFIG.baseFontSize, 'background-color': 'data(color)', 'text-outline-width': 20, 'text-outline-color': '#fff' }},
                        { selector: 'edge', style: { 'width': CONFIG.edgeWidth, 'line-color': '#ccc', 'opacity': 0.2, 'curve-style': 'bezier', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#ccc' }},
                        { selector: '.faded', style: { 'opacity': 0.05, 'text-opacity': 0 }},
                        { selector: '.highlight-node', style: { 'z-index': 999, 'border-width': 60, 'border-color': '#000' }},
                        { selector: '.edge-out', style: { 'line-color': 'red', 'target-arrow-color': 'red', 'opacity': 1 }},
                        { selector: '.edge-in', style: { 'line-color': 'blue', 'target-arrow-color': 'blue', 'opacity': 1 }}
                    ],
                    layout: { name: 'preset' }
                });

                cy.on('tap', 'node', function(e){ selectNode(e.target); openPanel(e.target.data()); });

                // Ê§úÁ¥¢
                searchInput.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    searchResults.innerHTML = '';
                    if (!val) { searchResults.style.display = 'none'; return; }
                    const matches = cy.nodes().filter(n => {
                        const lbl = n.data('label');
                        return lbl && typeof lbl === 'string' && lbl.toLowerCase().includes(val);
                    });
                    if (matches.length > 0) {
                        searchResults.style.display = 'block';
                        matches.slice(0, 10).forEach(m => {
                            const div = document.createElement('div');
                            div.className = 'search-item'; div.innerText = m.data('label');
                            div.onmousedown = (ev) => {
                                ev.preventDefault();
                                selectNode(m); openPanel(m.data());
                                cy.animate({ center: { eles: m }, zoom: 0.02 }, { duration: 1000 });
                                searchResults.style.display = 'none'; searchInput.value = m.data('label');
                            };
                            searchResults.appendChild(div);
                        });
                    } else { searchResults.style.display = 'none'; }
                });

                // --- ÈáçË¶ÅÔºö„ÉÑ„Ç¢„ÉºÂÜçÁîü„Çπ„Ç§„ÉÉ„ÉÅ„ÅÆÁ¢∫ÂÆü„Å™„Ç§„Éô„É≥„ÉàÁôªÈå≤ ---
                const ts = document.getElementById('tour-switch');
                const tHeader = document.getElementById('tour-label-area');
                
                const toggleFunction = function(e) {
                    if (e.target.id !== 'tour-switch') {
                        ts.checked = !ts.checked;
                    }
                    const status = document.getElementById('tour-status');
                    if (ts.checked) {
                        status.style.display = 'block';
                        startTour();
                    } else {
                        status.style.display = 'none';
                        stopTour();
                    }
                };

                tHeader.onclick = toggleFunction;
                ts.onclick = function(e) { e.stopPropagation(); }; // ‰∫åÈáçÁô∫ÁÅ´Èò≤Ê≠¢

                adjustView(false);
                addLog(`ÊèèÁîªÂÆå‰∫Ü: ${fullData.nodes.length} nodes`);
            } catch (err) { addLog("Error: " + err.message); }
        }

        function selectNode(node) {
            const id = node.id();
            cy.elements().addClass('faded').removeClass('highlight-node edge-out edge-in');
            node.removeClass('faded').addClass('highlight-node');
            node.connectedEdges().forEach(edge => {
                edge.removeClass('faded');
                if (edge.source().id() === id) edge.addClass('edge-out');
                else edge.addClass('edge-in');
            });
            node.neighborhood().nodes().removeClass('faded');
        }

        function openPanel(data) {
            document.getElementById('panel-title').innerText = data.label;
            const spotifyArea = document.getElementById('spotify-area');
            const linkArea = document.getElementById('link-area');
            
            linkArea.innerHTML = data.url_lastfm ? `<a href="${data.url_lastfm}" target="_blank" class="lastfm-btn">Last.fm „ÅßË©≥„Åó„ÅèË¶ã„Çã</a>` : '';
            
            if (data.spotify_id && data.spotify_id.length > 10 && !data.spotify_id.includes('-')) {
                const cleanId = String(data.spotify_id).replace('spotify:artist:', '').trim();
                spotifyArea.innerHTML = `<iframe src="https://open.spotify.com/embed/artist/${cleanId}?utm_source=generator" width="100%" height="152" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" style="border:none;"></iframe>`;
            } else {
                spotifyArea.innerHTML = `<div style="padding: 20px; color: #666; font-size: 13px; text-align: center;">Spotify IDÊú™ÁôªÈå≤</div>`;
            }
            sidePanel.classList.add('open');
            if(document.getElementById('tour-switch').checked) {
                timeLeft = DEFAULT_TIME;
                document.getElementById('timer-count').innerText = timeLeft;
            }
        }

        function closePanel() { sidePanel.classList.remove('open'); stopTour(); }

        function resetSelection() { closePanel(); cy.elements().removeClass('faded highlight-node edge-out edge-in'); searchInput.value = ''; adjustView(true); }

        function startTour() {
            clearInterval(tourInterval);
            timeLeft = DEFAULT_TIME;
            document.getElementById('timer-count').innerText = timeLeft;
            tourInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-count').innerText = timeLeft;
                if (timeLeft <= 0) jumpNextNode();
            }, 1000);
        }

        function stopTour() {
            clearInterval(tourInterval);
            const ts = document.getElementById('tour-switch');
            if(ts) ts.checked = false;
            const tstatus = document.getElementById('tour-status');
            if(tstatus) tstatus.style.display = 'none';
        }

        function jumpNextNode() {
            if (!cy) return;
            const current = cy.nodes('.highlight-node');
            if (current.length === 0) return;
            const neighbors = current.neighborhood().nodes();
            let next = (neighbors.length > 0) ? neighbors[Math.floor(Math.random() * neighbors.length)] : cy.nodes().not(current).randomElement();
            if (next) {
                selectNode(next);
                openPanel(next.data());
                cy.animate({ center: { eles: next }, zoom: 0.02 }, { duration: 1500 });
            }
        }

        window.addEventListener('resize', () => { adjustView(true); });
        start();
    </script>
</body>
</html>
