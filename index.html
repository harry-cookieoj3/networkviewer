<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Data Debugger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #111; color: #0f0; font-family: monospace; }
        #log-panel { position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: rgba(0,0,0,0.9); overflow-y: auto; z-index: 100; border-bottom: 2px solid #0f0; padding: 10px; font-size: 11px; }
        #cy { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; }
        .log-err { color: #f44; }
        .log-val { color: #ff0; }
    </style>
</head>
<body>
    <div id="log-panel"><div>--- SYSTEM LOG START ---</div></div>
    <div id="cy"></div>

    <script>
        const FILE_ID = '1Be7JMrTnqoarJ9R1Bdv3cZttJ0WPa73cisuYTERuYNY';

        function log(msg, cls='') {
            const div = document.createElement('div');
            div.className = cls;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            const panel = document.getElementById('log-panel');
            panel.appendChild(div);
            panel.scrollTop = panel.scrollHeight;
        }

        async function init() {
            try {
                const nodeUrl = `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&gid=0`;
                log("通信開始...");
                
                const resp = await fetch(nodeUrl);
                const csvText = await resp.text();
                log(`受信完了: ${csvText.length} 文字`);

                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, transformHeader: h => h.trim().toLowerCase() });
                const data = parsed.data;
                log(`解析成功: ${data.length} 件のノード`);

                if (data.length > 0) {
                    log(`[サンプル] ID: ${data[0].id}, X: ${data[0].x}, Y: ${data[0].y}`, "log-val");
                }

                const elements = data.map((row, i) => {
                    const x = parseFloat(row.x || 0) * 50;
                    const y = parseFloat(row.y || 0) * 50;
                    if(i < 3) log(`Node[${i}]計算座標: ${x}, ${y}`, "log-val");
                    
                    return {
                        group: 'nodes',
                        data: { id: String(row.id || i), label: row.label || row.id, color: row.color || '#1a73e8' },
                        position: { x: x, y: y }
                    };
                });

                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: { 'width': 30, 'height': 30, 'label': 'data(label)', 'background-color': 'data(color)', 'font-size': 12 } },
                        { selector: 'edge', style: { 'width': 2, 'line-color': '#ccc' } }
                    ],
                    layout: { name: 'preset' }
                });

                // 【最重要】データが存在する場所にカメラを強制移動
                cy.fit(); 
                log(`ズーム完了。現在のズーム倍率: ${cy.zoom()}`);
                
                if (cy.nodes().length > 0) {
                    const center = cy.nodes()[0].position();
                    log(`Node[0]の画面上位置: x:${center.x.toFixed(2)}, y:${center.y.toFixed(2)}`, "log-val");
                }

            } catch (e) {
                log("致命的エラー: " + e.message, "log-err");
            }
        }
        init();
    </script>
</body>
</html>
